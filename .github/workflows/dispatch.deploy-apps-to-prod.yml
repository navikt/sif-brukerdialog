name: Deploy apps to prod

on:
    push:
        branches:
            - main
        paths:
            - "apps/**/*"
            - "server/**/*"
            - "packages/**/*"
    workflow_dispatch:
        inputs:
            app:
                description: "Select app to deploy"
                required: true
                type: choice
                options:
                    - dine-pleiepenger
                    - ekstra-omsorgsdager-andre-forelder-ikke-tilsyn
                    - endringsmelding-pleiepenger
                    - omsorgsdager-aleneomsorg-dialog
                    - omsorgsdager-kalkulator
                    - omsorgspengerutbetaling-arbeidstaker-soknad
                    - omsorgspengerutbetaling-soknad
                    - omsorgspengesoknad
                    - opplaringspenger-soknad
                    - pleiepenger-i-livets-sluttfase-soknad
                    - pleiepenger-sykt-barn
                    - sif-ettersending
                    - ungdomsytelse-deltaker

permissions:
    contents: write
    security-events: write
    id-token: write
    actions: read

jobs:
    detect-changes:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest
        outputs:
            affected-apps: ${{ steps.turbo-filter.outputs.affected-apps }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0 # Need full history for turbo filtering

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "yarn"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Get affected apps with Turbo
              id: turbo-filter
              run: |
                  # Check if server files changed
                  if git diff --name-only HEAD^ HEAD | grep -q "^server/"; then
                      echo "Server changes detected - deploying all apps"
                      ALL_APPS="dine-pleiepenger,ekstra-omsorgsdager-andre-forelder-ikke-tilsyn,endringsmelding-pleiepenger,omsorgsdager-aleneomsorg-dialog,omsorgsdager-kalkulator,omsorgspengerutbetaling-arbeidstaker-soknad,omsorgspengerutbetaling-soknad,omsorgspengesoknad,opplaringspenger-soknad,pleiepenger-i-livets-sluttfase-soknad,pleiepenger-sykt-barn,sif-ettersending,ungdomsytelse-deltaker"
                      echo "affected-apps=$ALL_APPS" >> $GITHUB_OUTPUT
                      echo "Affected apps (server changed): $ALL_APPS"
                  else
                      # Get affected packages/apps since last commit using Turbo
                      AFFECTED_JSON=$(npx turbo run build --filter="...[HEAD^]" --dry=json || echo '{"packages":[]}')
                      AFFECTED_PACKAGES=$(echo "$AFFECTED_JSON" | jq -r '.packages // []')
                      
                      # Filter to only include actual apps (not packages)
                      AFFECTED_APPS=$(echo "$AFFECTED_PACKAGES" | jq -r 'map(select(startswith("@navikt/") and (contains("pleiepenger") or contains("omsorg") or contains("ungdom") or contains("ettersending") or contains("dine-") or contains("opplaringspenger") or contains("ekstra-"))))' || echo '[]')
                      
                      # Convert to simple names for workflow conditions
                      APP_NAMES=$(echo "$AFFECTED_APPS" | jq -r 'map(gsub("@navikt/"; "")) | join(",")')
                      
                      echo "affected-apps=$APP_NAMES" >> $GITHUB_OUTPUT
                      echo "Affected apps (turbo filtering): $APP_NAMES"
                  fi

    deploy-dine-pleiepenger:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'dine-pleiepenger' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'dine-pleiepenger'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "dine-pleiepenger"
            working-directory: "apps/dine-pleiepenger"
            package-name: "@navikt/dine-pleiepenger"
            is-next-app: true
            needs-env-file: true

    deploy-ekstra-omsorgsdager-andre-forelder-ikke-tilsyn:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'ekstra-omsorgsdager-andre-forelder-ikke-tilsyn' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'ekstra-omsorgsdager-andre-forelder-ikke-tilsyn'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "ekstra-omsorgsdager-andre-forelder-ikke-tilsyn"
            working-directory: "apps/ekstra-omsorgsdager-andre-forelder-ikke-tilsyn"
            package-name: "@navikt/ekstra-omsorgsdager-andre-forelder-ikke-tilsyn"

    deploy-endringsmelding-pleiepenger:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'endringsmelding-pleiepenger' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'endringsmelding-pleiepenger'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "endringsmelding-pleiepenger"
            working-directory: "apps/endringsmelding-pleiepenger"
            package-name: "@navikt/endringsmelding-pleiepenger"
            playwright-with-deps: true

    deploy-omsorgsdager-aleneomsorg-dialog:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'omsorgsdager-aleneomsorg-dialog' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'omsorgsdager-aleneomsorg-dialog'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "omsorgsdager-aleneomsorg-dialog"
            working-directory: "apps/omsorgsdager-aleneomsorg-dialog"
            package-name: "@navikt/omsorgsdager-aleneomsorg-dialog"

    deploy-omsorgsdager-kalkulator:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'omsorgsdager-kalkulator' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'omsorgsdager-kalkulator'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "omsorgsdager-kalkulator"
            working-directory: "apps/omsorgsdager-kalkulator"
            package-name: "@navikt/omsorgsdager-kalkulator"
            e2e-build-command: "build"

    deploy-omsorgspengerutbetaling-arbeidstaker-soknad:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'omsorgspengerutbetaling-arbeidstaker-soknad' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'omsorgspengerutbetaling-arbeidstaker-soknad'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "omsorgspengerutbetaling-arbeidstaker-soknad"
            working-directory: "apps/omsorgspengerutbetaling-arbeidstaker-soknad"
            package-name: "@navikt/omsorgspengerutbetaling-arbeidstaker-soknad"

    deploy-omsorgspengerutbetaling-soknad:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'omsorgspengerutbetaling-soknad' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'omsorgspengerutbetaling-soknad'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "omsorgspengerutbetaling-soknad"
            working-directory: "apps/omsorgspengerutbetaling-soknad"
            package-name: "@navikt/omsorgspengerutbetaling-soknad"

    deploy-omsorgspengesoknad:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'omsorgspengesoknad' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'omsorgspengesoknad'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "omsorgspengesoknad"
            working-directory: "apps/omsorgspengesoknad"
            package-name: "@navikt/omsorgspengesoknad"

    deploy-opplaringspenger-soknad:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'opplaringspenger-soknad' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'opplaringspenger-soknad'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "opplaringspenger-soknad"
            working-directory: "apps/opplaringspenger-soknad"
            package-name: "@navikt/opplaringspenger-soknad"

    deploy-pleiepenger-i-livets-sluttfase-soknad:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'pleiepenger-i-livets-sluttfase-soknad' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'pleiepenger-i-livets-sluttfase-soknad'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "pleiepenger-i-livets-sluttfase-soknad"
            working-directory: "apps/pleiepenger-i-livets-sluttfase-soknad"
            package-name: "@navikt/pleiepenger-i-livets-sluttfase-soknad"

    deploy-pleiepenger-sykt-barn:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'pleiepenger-sykt-barn' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'pleiepenger-sykt-barn'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "pleiepenger-sykt-barn"
            working-directory: "apps/pleiepenger-sykt-barn"
            package-name: "@navikt/pleiepenger-sykt-barn"
            playwright-with-deps: true

    deploy-sif-ettersending:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'sif-ettersending' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'sif-ettersending'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "sif-ettersending"
            working-directory: "apps/sif-ettersending"
            package-name: "@navikt/sif-ettersending"

    deploy-ungdomsytelse-deltaker:
        if: |
            always() &&
            (github.event_name == 'workflow_dispatch' && inputs.app == 'ungdomsytelse-deltaker' ||
             github.event_name == 'push' && contains(needs.detect-changes.outputs.affected-apps, 'ungdomsytelse-deltaker'))
        needs: [detect-changes]
        uses: ./.github/workflows/.test-and-deploy-to-prod.yml
        secrets: inherit
        with:
            app-name: "ungdomsytelse-deltaker"
            working-directory: "apps/ungdomsytelse-deltaker"
            package-name: "@navikt/ungdomsytelse-deltaker"
            use-turbo-test: true
            e2e-build-command: "e2e:build"
            run-sonar: true
