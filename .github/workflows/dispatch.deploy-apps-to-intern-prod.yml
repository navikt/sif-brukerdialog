name: Deploy apps to intern prod

on:
    push:
        branches:
            - main
        paths:
            - "apps-intern/ungdomsytelse-veileder/**/*"
            - "server-ungdomsytelse-veileder/**/*"
    workflow_dispatch:

jobs:
    detect-changes:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        outputs:
            should-deploy: ${{ steps.check-deploy.outputs.should-deploy }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "yarn"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Check if ungdomsytelse-veileder should deploy
              id: check-deploy
              run: |
                  # Check if server-ungdomsytelse-veileder changed
                  if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^server-ungdomsytelse-veileder/"; then
                      echo "Server changed - deploying ungdomsytelse-veileder"
                      echo "should-deploy=true" >> $GITHUB_OUTPUT
                  else
                      # Use Turborepo to check if ungdomsytelse-veileder is affected
                      set -o pipefail
                      AFFECTED_JSON=$(npx turbo run build --filter="[${{ github.event.before }}...${{ github.sha }}]" --dry=json)
                      TURBO_EXIT_CODE=$?
                      if [ $TURBO_EXIT_CODE -ne 0 ]; then
                          echo "ERROR: turbo command failed with exit code $TURBO_EXIT_CODE"
                          exit 1
                      fi
                      if echo "$AFFECTED_JSON" | jq -r '(.packages // []) | .[]' | grep -q "@navikt/ungdomsytelse-veileder"; then
                          echo "ungdomsytelse-veileder affected by changes"
                          echo "should-deploy=true" >> $GITHUB_OUTPUT
                      else
                          echo "ungdomsytelse-veileder not affected"
                          echo "should-deploy=false" >> $GITHUB_OUTPUT
                      fi
                  fi

    deploy-ungdomsytelse-veileder:
        if: |
            always() && (
                (github.event_name == 'workflow_dispatch') ||
                (github.event_name == 'push' && needs.detect-changes.result == 'success' && needs.detect-changes.outputs.should-deploy == 'true')
            )
        needs: [detect-changes]
        permissions:
            contents: write
            security-events: write
            id-token: write
            actions: read
        uses: ./.github/workflows/.test-and-deploy-to-intern-prod.yml
        secrets: inherit
        with:
            app-name: "ungdomsytelse-veileder"
            working-directory: "apps-intern/ungdomsytelse-veileder"
            package-name: "@navikt/ungdomsytelse-veileder"
            use-turbo-test: true
            e2e-build-command: "e2e:build"
            run-sonar: true
