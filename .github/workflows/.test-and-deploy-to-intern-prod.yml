name: Test and deploy app to internal prod (reusable)

on:
    workflow_call:
        inputs:
            app-name:
                required: true
                type: string
                description: "App name (e.g., 'ungdomsytelse-veileder')"
            working-directory:
                required: true
                type: string
                description: "Path to app directory (e.g., 'apps-intern/ungdomsytelse-veileder')"
            package-name:
                required: true
                type: string
                description: "Package name in monorepo (e.g., '@navikt/ungdomsytelse-veileder')"
            playwright-with-deps:
                required: false
                type: boolean
                default: false
                description: "Install Playwright with system dependencies (--with-deps)"
            use-turbo-test:
                required: false
                type: boolean
                default: false
                description: "Use 'yarn turbo test' instead of 'yarn test'"
            e2e-build-command:
                required: false
                type: string
                default: ""
                description: "Custom build command for e2e tests (e.g., 'e2e:build', 'build')"
            needs-env-file:
                required: false
                type: boolean
                default: false
                description: "Copy .env.dev to .env.production for next.js apps"
            run-sonar:
                required: false
                type: boolean
                default: false
                description: "Run SonarCloud scan after tests"

jobs:
    run-tests:
        uses: ./.github/workflows/.test-app.yml
        secrets: inherit
        permissions:
            contents: read
        with:
            app-name: ${{ inputs.app-name }}
            working-directory: ${{ inputs.working-directory }}
            package-name: ${{ inputs.package-name }}
            playwright-with-deps: ${{ inputs.playwright-with-deps }}
            use-turbo-test: ${{ inputs.use-turbo-test }}
            e2e-build-command: ${{ inputs.e2e-build-command }}
            needs-env-file: ${{ inputs.needs-env-file }}
            run-sonar: ${{ inputs.run-sonar }}

    deploy-to-intern-prod:
        name: Deploy ${{ inputs.app-name }} to internal prod
        needs: [run-tests]
        # Skip deploy on push commits containing [skip-prod-deploy]; always run via manual dispatch
        if: ${{ github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip-prod-deploy]') }}
        uses: ./.github/workflows/.deploy-app-to-intern-prod.yml
        secrets: inherit
        permissions:
            contents: write
            security-events: write
            id-token: write
            actions: read
        with:
            app-name: ${{ inputs.app-name }}
            working-directory: ${{ inputs.working-directory }}

    tag-deployment:
        if: success()
        needs: [deploy-to-intern-prod]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Create deployment tag
              continue-on-error: true
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
                  TAG_NAME="${{ inputs.app-name }}-intern-$(date +%Y%m%d-%H%M%S)-${SHORT_SHA}"
                  git tag -a "$TAG_NAME" -m "Deploy ${{ inputs.app-name }} to internal production"
                  git push origin "$TAG_NAME"
                  echo "Created tag: $TAG_NAME"
