
FROM node:16.15.1-alpine AS base
RUN apk update && apk add git

## Globally install turbo
RUN npm i -g turbo

# Prune the workspace for the `sif-ettersending` app
FROM base as pruner
COPY . .
COPY ../../turbo.json ./turbo.json
RUN turbo prune --scope=@navikt/sif-ettersending --docker=true

# # Add pruned lockfile and package.json's of the pruned subworkspace
FROM pruner AS installer
COPY --from=pruner /out/json/ .
COPY --from=pruner /out/yarn.lock ./yarn.lock
RUN yarn install --ignore-engines

# Copy source code of pruned subworkspace and build
FROM installer as builder
WORKDIR /app
COPY --from=installer . .
COPY --from=installer /out/full/ .
RUN turbo run build --scope=@navikt/sif-ettersending

# # Start the app
# FROM builder as runner
# EXPOSE 8080
# CMD ["yarn","--cwd", "apps/sif-ettersending", "start-express"]

# EXPOSE 3000
# RUN ['yarn', '--cwd', 'apps/@navikt/sif-ettersending', 'start']


# FROM node:16

# WORKDIR /usr/src/app

# COPY dist ./dist
# COPY server.js .
# COPY tokenx.js .
# COPY node_modules ./node_modules
# COPY package.json .
# COPY src/build/scripts/decorator.js ./src/build/scripts/decorator.js
# COPY envSettings.js ./envSettings.js

# EXPOSE 8080
# CMD ["yarn", "start-express"]
